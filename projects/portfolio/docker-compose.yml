version: "3.9"

services:
  laravel:
    image: ghcr.io/amgad226/laravel-portfolio:latest
    container_name: laravel_app
    restart: always
    expose:
      - "9000"
    env_file:
      - .env
    volumes:
      - laravel_storage:/var/www/html/storage
      - laravel_database:/var/www/html/database
      - laravel_public_build:/var/www/html/public/build
      - laravel_public_assets:/var/www/html/public/assets
    command: >
      sh -c "
      echo 'üöÄ Laravel container starting...' &&
      if [ \"$DB_CONNECTION\" = \"sqlite\" ] && [ ! -f \"$DB_DATABASE\" ]; then
        echo 'üì¶ Creating SQLite database...' &&
        touch \"$DB_DATABASE\" &&
        chown www-data:www-data \"$DB_DATABASE\"
      fi &&
      touch /var/www/html/database/database.sqlite &&
      chown -R www-data:www-data /var/www/html/database &&
      chmod -R 775 /var/www/html/database &&
      echo '‚è≥ Running migrations...' &&
      php artisan migrate --force &&
      echo '‚ö° Caching config...' &&
      php artisan config:clear &&
      php artisan config:cache &&
      php artisan route:cache || true &&
      echo '‚úÖ Starting PHP-FPM...' &&
      exec php-fpm
      "
  nginx:
    image: nginx:alpine
    container_name: laravel_nginx
    ports:
      - "80:80"
    volumes:
      - ./nginx/conf.d:/etc/nginx/conf.d
      - ./storage:/var/www/html/storage
      - ./database:/var/www/html/database
      - laravel_public_build:/var/www/html/public/build:ro
      - laravel_public_assets:/var/www/html/public/assets:ro
    depends_on:
      - laravel

volumes:
  laravel_storage:
  laravel_database:
  laravel_public_build:   # <-- shared volume for public/build
  laravel_public_assets:  # <-- shared volume for public/assets